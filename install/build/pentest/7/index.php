<?php
include('../header.php');

echo '<link rel="stylesheet" href="5.css">
<ul class="help-box">
	<li class="info-box"><b>Wiki:</b><br>
		<div><a target="_blank" href="https://www.owasp.org/index.php/Top_10_2013-A7-Missing_Function_Level_Access_Control">Missing Function Level Access Control</a></div>
	</li>
	<li class="info-box"><b>Tip:</b><br>
		After capturing the flag, leave a comment for the others. Thank you
	</li>
</ul>';


//Missing_Function_Level_Access_Control

//mostrar un login y luego se puede .. "postear algo"
//Mostrar que sin login se puede postear igual
include('../connect.php');

foreach ($_GET as $key => $value) {
	$_GET[$key] = htmlentities(addslashes($_GET[$key]));
}
foreach ($_POST as $key => $value) {
	$_POST[$key] = htmlentities(addslashes($_POST[$key]));
}  

if (!empty($_SERVER['HTTP_CLIENT_IP'])) {
    $ip = $_SERVER['HTTP_CLIENT_IP'];
} elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
    $ip = $_SERVER['HTTP_X_FORWARDED_FOR'];
} else {
    $ip = $_SERVER['REMOTE_ADDR'];
}

if (isset($_GET["delete"])){
	$foundIp = false;
	$sql=mysqli_query($con, "SELECT * FROM owasp_7_comments WHERE id = '$_GET[delete]'");
	while($row = mysqli_fetch_array($sql)){
		$foundIp = $row['ip'];
	}

	if ($foundIp != $ip AND $foundIp != false){
		echo 'Flag: f79b58da6cf87c128e4cb521d2ef6e86';
	}else{
		if ($foundIp == $ip){
			echo 'Your comment was successfully deleted';
		}
	}

	$sql2=("DELETE FROM owasp_7_comments WHERE id = '$_GET[delete]'");
	if (!mysqli_query($con, $sql2)){
		die("error");
	}
}

if (isset($_POST["comment"])){
	$sql=("INSERT INTO owasp_7_comments (ip, comment) VALUES ('$ip', '$_POST[comment]')");
	if (!mysqli_query($con, $sql)){
		die('error');
	}
}

echo '<form method="post" action="./index.php">
	<input type="text" name="comment" placeholder="Comment"><br>
	<input type="submit" value="SEND"><br>
</form>';

$sql=mysqli_query($con, "SELECT * FROM owasp_7_comments");
while($row = mysqli_fetch_array($sql)){

	echo '<hr>';
	if ($ip == $row["ip"]){
		echo '<a href="./index.php?delete='.$row["id"].'"><font color="#AA0000"><b>X</b></font></a>';
	}
	echo $row["ip"].': '.$row["comment"];
}
?>