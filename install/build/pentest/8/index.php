<?php
include('../connect.php');

$_GET = str_replace("'", '', $_GET);
$_POST = str_replace("'", '', $_POST);

if (!empty($_SERVER['HTTP_CLIENT_IP'])) {
    $ip = $_SERVER['HTTP_CLIENT_IP'];
} elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) {
    $ip = $_SERVER['HTTP_X_FORWARDED_FOR'];
} else {
    $ip = $_SERVER['REMOTE_ADDR'];
}


if ($_GET['data'] != true){
	include('../header.php');

	echo '<link rel="stylesheet" href="5.css">
	<ul class="help-box">
		<li class="info-box"><b>Wiki:</b><br>
			<div><a target="_blank" href="https://es.wikipedia.org/wiki/Cross-site_request_forgery">CSRF</a></div>
		</li>
		<li class="info-box"><b>Tip:</b><br>
			<div>Step 1: Register</div>
			<div>Step 2: Wait for others to vote for you. Meanwhile you can send comments to persuade voters ... persuade ... force ... is more or less the same, right?</div>
		</li>
		<li class="info-box" id="info-code" onclick="swapViewCode();"><pre>';
		$sourceCode = file_get_contents('index.php');
		$sourceCode = str_replace('662284a93c693f1e152c93d98ef80f36', 'XXX', $sourceCode);
		echo htmlentities($sourceCode);
		echo '</pre></li>	
	</ul>';

	$sql=mysqli_query($con, "SELECT * FROM owasp_3_users WHERE ip = '$ip'");
	while($row = mysqli_fetch_array($sql)){
		if ($row['likes'] > 0){
			echo 'FLAG: 662284a93c693f1e152c93d98ef80f36';
		}
	}
}
//XSS
	//permitir postear codigo y ese codigo tiene codigo JS que hace que las visitas sean redireccionadas



if (isset($_POST["comment"])){
	$sql=("INSERT INTO owasp_3_comments (comment) VALUES ('$_POST[comment]')");
	if (!mysqli_query($con, $sql)){
		die('error');
	}	
}

if (isset($_GET["vote"])){
	$error = false;
	$sql=mysqli_query($con, "SELECT * FROM owasp_3_users WHERE id = '$_GET[vote]' AND ip = '$ip'");
	while($row = mysqli_fetch_array($sql)){
		$error = true;
	}
	if ($error != true){
		mysqli_query($con, "UPDATE owasp_3_users SET likes = likes+1 WHERE id = '$_GET[vote]'");	
	}else{
		echo '<font color="#AA0000" size="20px">Impossible auto vote</font>';
	}
	
}

if (isset($_POST["name"])){
	$error = false;
	$sql=mysqli_query($con, "SELECT * FROM owasp_3_users WHERE ip = '$ip'");
	while($row = mysqli_fetch_array($sql)){
		$error = true;
	}
	if ($error == true){
		echo '<font color="#AA0000" size="20px">Already registered an account</font>';	
	}else{
		$sql=("INSERT INTO owasp_3_users (name, ip) VALUES ('$_POST[name]', '$ip')");
		if (!mysqli_query($con, $sql)){
			die('error');
		}			
	}
}

if (isset($_POST["comments"])){	
	$sql=("INSERT INTO owasp_3_comments (comments) VALUES ($_POST[comments])");
	if (!mysqli_query($con, $sql)){
		die('error');
	}	
}






if (isset($_GET["data"])){
	$rows = array();
	$table = array();
	$table['cols'] = array(
	    array('label' => 'Name', 'type' => 'string'),
	    array('label' => 'Likes', 'type' => 'number')
	);

	$rows = array();

	$sql=mysqli_query($con, "SELECT * FROM owasp_3_users ORDER by likes DESC");
	while($row = mysqli_fetch_array($sql)){
	    $temp = array();
	    $temp[] = array('v' => (string) $row['name']); 
	    $temp[] = array('v' => (int) $row['likes']); 
	    $rows[] = array('c' => $temp);
	}

	$table['rows'] = $rows;
	$jsonTable = json_encode($table);
	echo $jsonTable;
	exit();
}


echo '<form method="post" action="./index.php">
	<input type="text" name="name" placeholder="Your Name">
	<input type="submit" value="REGISTER ME, AS A NEW CANDIDATE">
</form>';



echo '<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

<div id="chart_div"> </div>';


echo '<script>


google.load(\'visualization\', \'1\', {packages: [\'corechart\', \'bar\']});
google.setOnLoadCallback(drawBasic);

function drawBasic() {

	var datos = $.ajax({
		url:"./index.php?data=true",
		type:"post",
		dataType:"json",
		async:false    		
	}).responseText;


      var data = new google.visualization.DataTable(JSON.parse(datos));

      var options = {
      	width: $(window).width()*0.6,
        title: \'Votes\',
        chartArea: {width: \'50%\'},
        hAxis: {
          title: \'Total Votes\',
          minValue: 0
        },
        vAxis: {
          title: \'Candidates\'
        }
      };

      var chart = new google.visualization.BarChart(document.getElementById(\'chart_div\'));

      chart.draw(data, options);
    }


    function pleaseNo(){
    	alert("If you vote for a candidate, you are going to make him win the challenge, without exploiting the vulnerability of CSRF ... behave please");
    }

</script>';

echo '<h1>Click over the name of the candidate to vote it...</h1>

<ul>';
$sql=mysqli_query($con, "SELECT * FROM owasp_3_users");
while($row = mysqli_fetch_array($sql)){
	echo '<li>
	<a class="vote" href="./index.php?vote='.$row["id"].'" onclick="pleaseNo();return false;">'.$row["name"].'</a>
	</li>';
}
echo '</ul>';
echo '<br><br><h1>Send new comment:</h1>
<form method="post" action="./index.php">
	<input type="text" name="comment" value="" placeholder="Your comments...">
	<input type="submit" value="SEND PERSUADE">
</form>';

echo '<br><br>Comments:';
$sql=mysqli_query($con, "SELECT * FROM owasp_3_comments");
while($row = mysqli_fetch_array($sql)){
	echo '<hr>
	'.$row["comment"];
}

?>