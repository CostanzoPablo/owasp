<?php
	include('./connect.php');

	echo '<link rel="stylesheet" href="css/base.css">
	<link rel="stylesheet" href="css/progress.css">
	<body>
	<div id="header">
		<img src="img/logo.png">
		<div id="reset"><a href="./index.php?dropAll=true" onclick="return confirm(\'Are you sure ? This action will restart the state of the database, with the exception of the rankings... Do not abuse the use of this function\')">Reset</a></div>
	</div>
	<div id="pwned"><img src="img/pwned2.png"></div>
	<ul>
		<a href="./1"><li class="menu-item">
			<span class="item-content"><h1>1</h1>
			<div>* SQL Injection</div>
			<div>* Path Traversal</div>
			<div>* OS Commanding</div>
			</span>
		</li></a>
		<a href="./2"><li class="menu-item">
			<span class="item-content"><h1>2</h1>
			<div>* Broken Authentication</div>
			</span>
		</li></a>		
		<a href="./3"><li class="menu-item">
			<span class="item-content"><h1>3</h1>
			<div>* XSS</div>
			</span>
		</li></a>
		<a href="./4"><li class="menu-item">
			<span class="item-content"><h1>4</h1>
			<div>* Insecure Direct Object References</div>
			</span>
		</li></a>
		<a href="./5"><li class="menu-item">
			<span class="item-content"><h1>5</h1>
			<div>* Security Misconfiguration</div>
			</span>
		</li></a>
		<a href="./6"><li class="menu-item">
			<span class="item-content"><h1>6</h1>
			<div>* Sensitive Data Exposure</div>
			<div>* Weak encryption</div>
			</span>
		</li></a>
		<a href="./7"><li class="menu-item">
			<span class="item-content"><h1>7</h1>
			<div>* Missing Function Level Access Control</div>
			</span>
		</li></a>
		<a href="./8"><li class="menu-item">
			<span class="item-content"><h1>8</h1>
			<div>* CSRF</div>
			</span>
		</li></a>
		<a href="./9"><li class="menu-item">
			<span class="item-content"><h1>9</h1>
			<div>* Unvalidated Redirects and Forwards </div>
			</span>
		</li></a>		
	</ul>

	<script>
		$(function() {
			$(".meter > span").each(function() {
				$(this)
					.data("origWidth", $(this).width())
					.width(0)
					.animate({
						width: $(this).data("origWidth")
					}, 1200);
			});
		});
	</script>';



	echo '<ul id="competitors">';
		if (isset($_GET['loadflag'])){
			for ($i=1; $i <= 9; $i++) { 
				$flags[md5('owaspflags3cur3'.$i)] = true;
			}
			$flags['uN10cK3D'] = true;
			if (isset($flags[$_POST['flag']])){
				foreach ($_GET as $key => $value) {
					$_GET[$key] = htmlentities(addslashes($_GET[$key]));
				}
				foreach ($_POST as $key => $value) {
					$_POST[$key] = htmlentities(addslashes($_POST[$key]));
				}  			
				$already = false;
				$sql=mysqli_query($con, "SELECT * FROM owasp_flags WHERE name = '$_POST[name]' AND flag = '$_POST[flag]'");
				while($row = mysqli_fetch_array($sql)){
					//already exists
					$already = true;
				}
				if ($already == false){
					$sql=("INSERT INTO owasp_flags (name, flag) VALUES ('$_POST[name]', '$_POST[flag]')");
					if (!mysqli_query($con, $sql)){
						echo mysqli_error($con);
						die('error');
					}
				}			
			}
		}
		$total = 9;
		$sql=mysqli_query($con, "SELECT name, count(flag) as flags FROM owasp_flags GROUP by name ASC ORDER by flags DESC");
		while($row = mysqli_fetch_array($sql)){
			echo '<li class="competitor">
				<div>';
				if ($row['flags'] == 10){
					echo '<img src="img/hacker.png" width="30px">';	
					echo  ' '.$row['name'].' '.round(($row['flags'] * 100)/10).'%</div>
					<div class="meter orange">
						<span style="width: '.(($row['flags'] * 100)/10).'%"></span>
					</div>';
				}else{
					echo '<img src="img/bug.png" width="30px">';
					echo  ' '.$row['name'].' '.round(($row['flags'] * 100)/10).'%</div>
					<div class="meter normal">
						<span style="width: '.(($row['flags'] * 100)/10).'%"></span>
					</div>';					
				}

			echo '</li>';
		}		


		echo '<li class="competitor">
			<form method="post" action="./index.php?loadflag">
				<input type="text" placeholder="Your name" name="name">
				<input type="text" placeholder="A flag..." name="flag">
				<input type="submit" value="LOAD FLAG">
			</form>
		</li>
	</ul>

	</body>';

?>
