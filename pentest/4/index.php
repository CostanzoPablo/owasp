<?php
session_start();
include('../header.php');
echo '<ul class="help-box">
	<li class="info-box"><b>Wiki:</b><br>
		<div><a target="_blank" href="https://www.owasp.org/index.php/Top_10_2007-Insecure_Direct_Object_Reference">Insecure Direct Object References</a></div>
	</li>
	<li class="info-box"><b>Tip:</b><br>
		Your salary account is user:secure!password. Can you try to see the salary account of another person, without brute force?
	</li>
</ul>';

//Insecure_Direct_Object_References

	//Permite editar por url el ID del cliente, y asi leer carros de compras... 

include('../connect.php');

foreach ($_GET as $key => $value) {
	$_GET[$key] = htmlentities(addslashes($_GET[$key]));
}
foreach ($_POST as $key => $value) {
	$_POST[$key] = htmlentities(addslashes($_POST[$key]));
}  

if (!isset($_SESSION["owasp"][4])){
	$_SESSION["owasp"][4] = false;
}

switch ($_GET["step"]){
	case 1:
		$_SESSION["owasp"][4] = false;
		$sql=mysqli_query($con, "SELECT * FROM owasp_4_users WHERE name = '$_POST[name]'");
		while($row = mysqli_fetch_array($sql)){
			if ($_POST["pass"] == $row["pass"]){
				$_SESSION["owasp"][4] = $row["id"];
			}
		}

		if ($_SESSION["owasp"][4] == false){
			echo '<div>Name or Password incorrect</div>';
		}
		break;
	case 2:
		$_SESSION["owasp"][4] = false;
		break;
}

if ($_SESSION["owasp"][4] == false){
	echo '<font color="#AA0000"><b>Restricted Access !</b></font>
	<form method="post" action="./index.php?step=1">
		<input type="text" name="name" placeholder="Name">
		<input type="password" name="pass" placeholder="Password">
		<input type="submit" value="LOG IN">
	</form>';
	exit();
}else{
	echo '&nbsp;<font color="#00AA00"><b>IDENTIFICATED !</b></font> (<a href="./index.php?step=2">LOG OUT</a>)';	
	$a = $_SESSION[owasp][4];
	$sql=mysqli_query($con, "SELECT * FROM owasp_4_users WHERE id = $a");
	while($row = mysqli_fetch_array($sql)){
		echo '<br><font size="2" color="#00AA00">YOUR SALARY: '.$row["salary"].'</font>';
	}	
	

	if (isset($_GET["newpass"])){
		if ($_POST["pass"] == $_POST["rpass"]){
			if ($_GET["newpass"] == 1){
				echo '<div>Changing account:"user" password is not activated</div>';
			}else{
				mysqli_query($con, "UPDATE owasp_4_users SET pass = '$_POST[pass]' WHERE id = '$_GET[newpass]'");	
				$sql=mysqli_query($con, "SELECT * FROM owasp_4_users WHERE id = '$_GET[newpass]'");
				while($row = mysqli_fetch_array($sql)){
					echo '<br>Password for account: "'.$row["name"].'" changed successfully';
				}	
			}
			
		}else{
			echo '<font color="#AA0000">ERROR...</font>';
		}
	}	
}	

echo '<div><b>CONTROL PANEL</b></div>
<form method="post" action="./index.php?newpass='.$_SESSION["owasp"][4].'">
	<div>New password: <input type="password" name="pass"></div>
	<div>Repeat new password: <input type="password" name="rpass"></div>
	<div><input type="submit" value="CHANGE"></div>
</form>';
?>