<?php
session_start();
include('../header.php');

echo '<ul class="help-box">
	<li class="info-box"><b>Wiki:</b><br>
		<div><a target="_blank" href="https://es.wikipedia.org/wiki/Inyecci%C3%B3n_SQL">SQL Injection</a></div>
		<div><a target="_blank" href="https://es.wikipedia.org/wiki/Directory_traversal">Path Traversal</a></div>
		<div><a target="_blank" href="https://en.wikipedia.org/wiki/Arbitrary_code_execution">OS Commanding</a></div>
	</li>
	<li class="info-box"><b>Tip:</b><br>
		As a first step, try to identify yourself by applying SQL Injection. Then try to access other documents that are not showing you.
	</li>
</ul>';

//SQL Injection
//OS Commanding
include('../connect.php');

if (!isset($_SESSION["owasp"][1])){
	$_SESSION["owasp"][1] = false;
}

switch ($_GET["step"]) {
	case 1:
		$_SESSION["owasp"][1] = false;
		$sql=mysqli_query($con, "SELECT * FROM owasp_1_users WHERE name = '$_POST[name]' AND pass = '$_POST[pass]'");
		while($row = mysqli_fetch_array($sql)){
			$_SESSION["owasp"][1] = true;
		}

		if ($_SESSION["owasp"][1] == false){
			echo '<div>Name or Password incorrect</div>';
		}
		break;
	case 2:
		$_SESSION["owasp"][1] = false;
		break;
}

if ($_SESSION["owasp"][1] == false){
	echo '<font color="#AA0000"><b>Restricted Access !</b></font>
	<form method="post" action="./index.php?step=1">
		<input type="text" name="name" placeholder="Name">
		<input type="password" name="pass" placeholder="Password">
		<input type="submit" value="LOG IN">
	</form>';
	exit();
}else{
	echo '<font color="#00AA00"><b>IDENTIFICATED ! (Flag 1 of 2 OK) Flag 1: fdfb821c516b1abfaff67978932574e6</b></font> (<a href="./index.php?step=2">LOG OUT</a>)';	
}	

echo '<form method="post" action="./index.php">
	<input type="hidden" value="./documents" name="documents">
	<input type="submit" value="LIST DOCUMENTS">
</form>';

if (isset($_POST["documents"])){
	$command = shell_exec('ls '.$_POST["documents"]);
	$files = preg_split('/[\r\n]+/', $command);
	$i = 0;
	foreach ($files as $key => $value) {
		echo '<div><a href="./documents/'.$value.'" target="_blank">'.$value.'</a></div>';
	}
}
include('../footer.php');
?>